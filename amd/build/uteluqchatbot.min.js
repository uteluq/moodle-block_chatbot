define(["jquery","core/str","core/ajax","core/notification"],function(i,s,a,t){return{init:function(t,e,c,r){function n(){var t=document.querySelector(".block_uteluqchatbot #promptModal");t.style.display="none"===t.style.display?"block":"none"}function u(){var t,e=document.querySelector(".block_uteluqchatbot #fileUploadModal");e&&(e.style.display="none"===e.style.display||""===e.style.display?"flex":"none","none"===e.style.display)&&(e=document.querySelector(".block_uteluqchatbot #fileUploadForm"),t=document.querySelector(".block_uteluqchatbot #uploadedFilesContainer"),e&&e.reset(),t)&&(t.innerHTML="")}i(".block_uteluqchatbot #chatform").on("submit",function(t){t.preventDefault();let n=i(".block_uteluqchatbot #question").val(),o=i(".block_uteluqchatbot #error-message");s.get_string("sending_question","block_uteluqchatbot").then(function(t){o.text(t)}).catch(function(){s.get_string("sending_question_fallback","block_uteluqchatbot").then(function(t){o.text(t)}).catch(function(){o.text("Sending the question...")})});t={methodname:"block_uteluqchatbot_send_question",args:{question:n,userid:c,courseid:r,sansrag:!1}};a.call([t])[0].then(function(e){var t;o.text(""),"error"===e.status?s.get_string("error","block_uteluqchatbot").then(function(t){o.text(t+": "+e.error)}).catch(function(){s.get_string("error_colon_fallback","block_uteluqchatbot").then(function(t){o.text(t+e.error)}).catch(function(){o.text("Error: "+e.error)})}):((t=i(".block_uteluqchatbot #chat-messages")).append(`
                            <div class="message user-message">${n}</div>
                            <div class="message bot-message">${e.answer}</div>
                        `),i(".block_uteluqchatbot #question").val(""),t.scrollTop(t[0].scrollHeight))}).catch(function(n){console.error("Error:",n),s.get_string("unknown_error_occurred","block_uteluqchatbot").then(function(t){let e=n&&n.message?n.message:t;s.get_string("error_sending_question","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){s.get_string("error_sending_question_fallback","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){o.text("Error sending the question: "+e)})})}).catch(function(){let e=n&&n.message?n.message:"Unknown error occurred";s.get_string("error_sending_question","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){s.get_string("error_sending_question_fallback","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){o.text("Error sending the question: "+e)})})})})}),i(".block_uteluqchatbot #promptform").on("submit",function(t){t.preventDefault();t=i(".block_uteluqchatbot #prompttext").val();let o=i(".block_uteluqchatbot #error-message");s.get_string("saving_prompt","block_uteluqchatbot").then(function(t){o.text(t)}).catch(function(){s.get_string("saving_prompt_fallback","block_uteluqchatbot").then(function(t){o.text(t)}).catch(function(){o.text("Saving the prompt...")})}),a.call([{methodname:"block_uteluqchatbot_save_prompt",args:{prompttext:t,userid:c,courseid:r}}])[0].then(function(e){o.text(""),"error"===e.status?s.get_string("error","block_uteluqchatbot").then(function(t){o.text(t+": "+e.error)}).catch(function(){s.get_string("error_colon_fallback","block_uteluqchatbot").then(function(t){o.text(t+e.error)}).catch(function(){o.text("Error: "+e.error)})}):(s.get_string("prompt_saved_successfully","block_uteluqchatbot").then(function(t){o.text(t)}).catch(function(){s.get_string("prompt_saved_successfully_fallback","block_uteluqchatbot").then(function(t){o.text(t)}).catch(function(){o.text("Prompt saved successfully!")})}),n(),setTimeout(function(){location.reload()},1500))}).catch(function(n){console.error("Error:",n),s.get_string("unknown_error_occurred","block_uteluqchatbot").then(function(t){let e=n&&n.message?n.message:t;s.get_string("error_saving_prompt","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){s.get_string("error_saving_prompt_fallback","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){o.text("Error saving the prompt: "+e)})})}).catch(function(){let e=n&&n.message?n.message:"Unknown error occurred";s.get_string("error_saving_prompt","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){s.get_string("error_saving_prompt_fallback","block_uteluqchatbot").then(function(t){o.text(t+e)}).catch(function(){o.text("Error saving the prompt: "+e)})})})})});let l=document.querySelector(".block_uteluqchatbot #fileUploadForm");l&&l.addEventListener("submit",function(t){t.preventDefault();t=document.querySelector(".block_uteluqchatbot #file");let o=document.querySelector(".block_uteluqchatbot #error-message");t&&t.files&&0!==t.files.length?(s.get_string("uploading_file","block_uteluqchatbot").then(function(t){o.textContent=t}).catch(function(){s.get_string("uploading_files_fallback","block_uteluqchatbot").then(function(t){o.textContent=t}).catch(function(){o.textContent="Uploading files..."})}),(t=>{t=Array.from(t).map(o=>new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{var t=n.result.split(",")[1];e({filename:o.name,filecontent:t})},n.onerror=t,n.readAsDataURL(o)}));return Promise.all(t)})(t.files).then(function(t){s.get_string("files_converted_debug","block_uteluqchatbot").then(function(t){}).catch(function(){});t={methodname:"block_uteluqchatbot_upload_files",args:{courseid:r,files:t}};return s.get_string("sending_ajax_request_debug","block_uteluqchatbot").then(function(t){}).catch(function(){}),a.call([t])[0]}).then(function(n){var t;s.get_string("upload_response_received_debug","block_uteluqchatbot").then(function(t){}).catch(function(){}),s.get_string("response_type_debug","block_uteluqchatbot").then(function(t){}).catch(function(){}),o.textContent="",n&&n.success?(s.get_string("file_indexed_successfully","block_uteluqchatbot").then(function(t){o.textContent=t}).catch(function(){s.get_string("files_indexed_successfully_fallback","block_uteluqchatbot").then(function(t){o.textContent=t}).catch(function(){o.textContent=n.message||"Files indexed successfully!"})}),l.reset(),(t=document.querySelector(".block_uteluqchatbot #uploadedFilesContainer"))&&(t.innerHTML=""),u(),setTimeout(function(){location.reload()},1500)):s.get_string("unknown_error","block_uteluqchatbot").then(function(t){let e=n&&n.message?n.message:t;s.get_string("error_processing_file","block_uteluqchatbot").then(function(t){o.textContent=t+": "+e}).catch(function(){s.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){o.textContent=t+e}).catch(function(){o.textContent="Error processing files: "+e})})}).catch(function(){let e=n&&n.message?n.message:"Unknown error";s.get_string("error_processing_file","block_uteluqchatbot").then(function(t){o.textContent=t+": "+e}).catch(function(){s.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){o.textContent=t+e}).catch(function(){o.textContent="Error processing files: "+e})})})}).catch(function(n){s.get_string("upload_error_details_debug","block_uteluqchatbot").then(function(t){console.error(t,n)}).catch(function(){console.error("Upload error details:",n)}),s.get_string("error_object_debug","block_uteluqchatbot").then(function(t){}).catch(function(){}),n&&n.responseText?(s.get_string("raw_server_response_debug","block_uteluqchatbot").then(function(t){}).catch(function(){}),s.get_string("server_response_error","block_uteluqchatbot").then(function(t){o.textContent=t}).catch(function(){o.textContent="Server response error. Check console for details."})):s.get_string("unknown_error_occurred","block_uteluqchatbot").then(function(t){let e=t;n&&("string"==typeof n?e=n:n.message?e=n.message:n.error?e=n.error:n.exception&&n.exception.message?e=n.exception.message:s.get_string("server_error_check_console","block_uteluqchatbot").then(function(t){e=t}).catch(function(){e="Server error - check console for details"})),s.get_string("error_processing_file","block_uteluqchatbot").then(function(t){o.textContent=t+": "+e}).catch(function(){s.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){o.textContent=t+e}).catch(function(){o.textContent="Error processing files: "+e})})}).catch(function(){let e="Unknown error occurred";n&&(e="string"==typeof n?n:n.message||n.error||(n.exception&&n.exception.message?n.exception.message:"Server error - check console for details")),s.get_string("error_processing_file","block_uteluqchatbot").then(function(t){o.textContent=t+": "+e}).catch(function(){s.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){o.textContent=t+e}).catch(function(){o.textContent="Error processing files: "+e})})})})):s.get_string("no_files_selected","block_uteluqchatbot").then(function(t){o.textContent=t}).catch(function(){s.get_string("no_files_selected_fallback","block_uteluqchatbot").then(function(t){o.textContent=t}).catch(function(){o.textContent="No files selected."})})}),window.togglePromptModal=n,window.toggleFileUploadModal=u}}});