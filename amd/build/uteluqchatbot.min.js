define(["jquery","core/str","core/ajax","core/notification"],function(s,i,a,t){return{init:function(t,e,c,r){function o(){var t=document.querySelector(".block_uteluqchatbot #promptModal");t.style.display="none"===t.style.display?"block":"none"}function l(){var t,e=document.querySelector(".block_uteluqchatbot #fileUploadModal");e&&(e.style.display="none"===e.style.display||""===e.style.display?"flex":"none","none"===e.style.display)&&(e=document.querySelector(".block_uteluqchatbot #fileUploadForm"),t=document.querySelector(".block_uteluqchatbot #uploadedFilesContainer"),e&&e.reset(),t)&&(t.innerHTML="")}s(".block_uteluqchatbot #chatform").on("submit",function(t){t.preventDefault();let o=s(".block_uteluqchatbot #question").val(),n=s(".block_uteluqchatbot #error-message");i.get_string("sending_question","block_uteluqchatbot").then(function(t){n.text(t)}).catch(function(){i.get_string("sending_question_fallback","block_uteluqchatbot").then(function(t){n.text(t)}).catch(function(){n.text("Sending the question...")})});t={methodname:"block_uteluqchatbot_send_question",args:{question:o,userid:c,courseid:r,sansrag:!1}};a.call([t])[0].then(function(e){var t;n.text(""),"error"===e.status?i.get_string("error","block_uteluqchatbot").then(function(t){n.text(t+": "+e.error)}).catch(function(){i.get_string("error_colon_fallback","block_uteluqchatbot").then(function(t){n.text(t+e.error)}).catch(function(){n.text("Error: "+e.error)})}):((t=s(".block_uteluqchatbot #chat-messages")).append(`
                            <div class="message user-message">${o}</div>
                            <div class="message bot-message">${e.answer}</div>
                        `),s(".block_uteluqchatbot #question").val(""),t.scrollTop(t[0].scrollHeight))}).catch(function(o){console.error("Error:",o),i.get_string("unknown_error_occurred","block_uteluqchatbot").then(function(t){let e=o&&o.message?o.message:t;i.get_string("error_sending_question","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){i.get_string("error_sending_question_fallback","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){n.text("Error sending the question: "+e)})})}).catch(function(){let e=o&&o.message?o.message:"Unknown error occurred";i.get_string("error_sending_question","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){i.get_string("error_sending_question_fallback","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){n.text("Error sending the question: "+e)})})})})}),s(".block_uteluqchatbot #promptform").on("submit",function(t){t.preventDefault();t=s(".block_uteluqchatbot #prompttext").val();let n=s(".block_uteluqchatbot #error-message");i.get_string("saving_prompt","block_uteluqchatbot").then(function(t){n.text(t)}).catch(function(){i.get_string("saving_prompt_fallback","block_uteluqchatbot").then(function(t){n.text(t)}).catch(function(){n.text("Saving the prompt...")})}),a.call([{methodname:"block_uteluqchatbot_save_prompt",args:{prompttext:t,userid:c,courseid:r}}])[0].then(function(e){n.text(""),"error"===e.status?i.get_string("error","block_uteluqchatbot").then(function(t){n.text(t+": "+e.error)}).catch(function(){i.get_string("error_colon_fallback","block_uteluqchatbot").then(function(t){n.text(t+e.error)}).catch(function(){n.text("Error: "+e.error)})}):(i.get_string("prompt_saved_successfully","block_uteluqchatbot").then(function(t){n.text(t)}).catch(function(){i.get_string("prompt_saved_successfully_fallback","block_uteluqchatbot").then(function(t){n.text(t)}).catch(function(){n.text("Prompt saved successfully!")})}),o(),setTimeout(function(){location.reload()},1500))}).catch(function(o){console.error("Error:",o),i.get_string("unknown_error_occurred","block_uteluqchatbot").then(function(t){let e=o&&o.message?o.message:t;i.get_string("error_saving_prompt","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){i.get_string("error_saving_prompt_fallback","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){n.text("Error saving the prompt: "+e)})})}).catch(function(){let e=o&&o.message?o.message:"Unknown error occurred";i.get_string("error_saving_prompt","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){i.get_string("error_saving_prompt_fallback","block_uteluqchatbot").then(function(t){n.text(t+e)}).catch(function(){n.text("Error saving the prompt: "+e)})})})})});let u=document.querySelector(".block_uteluqchatbot #fileUploadForm");u&&u.addEventListener("submit",function(t){t.preventDefault();t=document.querySelector(".block_uteluqchatbot #file");let n=document.querySelector(".block_uteluqchatbot #error-message");t&&t.files&&0!==t.files.length?(i.get_string("uploading_file","block_uteluqchatbot").then(function(t){n.textContent=t}).catch(function(){i.get_string("uploading_files_fallback","block_uteluqchatbot").then(function(t){n.textContent=t}).catch(function(){n.textContent="Uploading files..."})}),(t=>{t=Array.from(t).map(n=>new Promise((e,t)=>{let o=new FileReader;o.onload=()=>{var t=o.result.split(",")[1];e({filename:n.name,filecontent:t})},o.onerror=t,o.readAsDataURL(n)}));return Promise.all(t)})(t.files).then(function(e){i.get_string("files_converted_debug","block_uteluqchatbot").then(function(t){console.log(t,e.length)}).catch(function(){console.log("Files converted to base64:",e.length)});let o={methodname:"block_uteluqchatbot_upload_files",args:{courseid:r,files:e}};return i.get_string("sending_ajax_request_debug","block_uteluqchatbot").then(function(t){console.log(t,o)}).catch(function(){console.log("Sending AJAX request:",o)}),a.call([o])[0]}).then(function(o){var t;i.get_string("upload_response_received_debug","block_uteluqchatbot").then(function(t){console.log(t,o)}).catch(function(){console.log("Upload response received:",o)}),i.get_string("response_type_debug","block_uteluqchatbot").then(function(t){console.log(t,typeof o)}).catch(function(){console.log("Response type:",typeof o)}),n.textContent="",o&&o.success?(i.get_string("file_indexed_successfully","block_uteluqchatbot").then(function(t){n.textContent=t}).catch(function(){i.get_string("files_indexed_successfully_fallback","block_uteluqchatbot").then(function(t){n.textContent=t}).catch(function(){n.textContent=o.message||"Files indexed successfully!"})}),u.reset(),(t=document.querySelector(".block_uteluqchatbot #uploadedFilesContainer"))&&(t.innerHTML=""),l(),setTimeout(function(){location.reload()},1500)):i.get_string("unknown_error","block_uteluqchatbot").then(function(t){let e=o&&o.message?o.message:t;i.get_string("error_processing_file","block_uteluqchatbot").then(function(t){n.textContent=t+": "+e}).catch(function(){i.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){n.textContent=t+e}).catch(function(){n.textContent="Error processing files: "+e})})}).catch(function(){let e=o&&o.message?o.message:"Unknown error";i.get_string("error_processing_file","block_uteluqchatbot").then(function(t){n.textContent=t+": "+e}).catch(function(){i.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){n.textContent=t+e}).catch(function(){n.textContent="Error processing files: "+e})})})}).catch(function(o){i.get_string("upload_error_details_debug","block_uteluqchatbot").then(function(t){console.error(t,o)}).catch(function(){console.error("Upload error details:",o)}),i.get_string("error_object_debug","block_uteluqchatbot").then(function(t){console.log(t,JSON.stringify(o,null,2))}).catch(function(){console.log("Error object:",JSON.stringify(o,null,2))}),o&&o.responseText?(i.get_string("raw_server_response_debug","block_uteluqchatbot").then(function(t){console.log(t,o.responseText)}).catch(function(){console.log("Raw server response:",o.responseText)}),i.get_string("server_response_error","block_uteluqchatbot").then(function(t){n.textContent=t}).catch(function(){n.textContent="Server response error. Check console for details."})):i.get_string("unknown_error_occurred","block_uteluqchatbot").then(function(t){let e=t;o&&("string"==typeof o?e=o:o.message?e=o.message:o.error?e=o.error:o.exception&&o.exception.message?e=o.exception.message:i.get_string("server_error_check_console","block_uteluqchatbot").then(function(t){e=t}).catch(function(){e="Server error - check console for details"})),i.get_string("error_processing_file","block_uteluqchatbot").then(function(t){n.textContent=t+": "+e}).catch(function(){i.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){n.textContent=t+e}).catch(function(){n.textContent="Error processing files: "+e})})}).catch(function(){let e="Unknown error occurred";o&&(e="string"==typeof o?o:o.message||o.error||(o.exception&&o.exception.message?o.exception.message:"Server error - check console for details")),i.get_string("error_processing_file","block_uteluqchatbot").then(function(t){n.textContent=t+": "+e}).catch(function(){i.get_string("error_processing_files_fallback","block_uteluqchatbot").then(function(t){n.textContent=t+e}).catch(function(){n.textContent="Error processing files: "+e})})})})):i.get_string("no_files_selected","block_uteluqchatbot").then(function(t){n.textContent=t}).catch(function(){i.get_string("no_files_selected_fallback","block_uteluqchatbot").then(function(t){n.textContent=t}).catch(function(){n.textContent="No files selected."})})}),window.togglePromptModal=o,window.toggleFileUploadModal=l}}});